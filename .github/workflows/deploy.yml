name: Deploy MEAN App

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Docker login
      - name: Login DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 3ï¸âƒ£ Build images
      - name: Build backend
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mean-backend ./backend

      - name: Build frontend
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mean-frontend ./frontend

      # 4ï¸âƒ£ Push images
      - name: Push backend
        run: docker push ${{ secrets.DOCKER_USERNAME }}/mean-backend

      - name: Push frontend
        run: docker push ${{ secrets.DOCKER_USERNAME }}/mean-frontend

      # 5ï¸âƒ£ Deploy EC2
      - name: Deploy EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ”¥ Clean old containers"
            sudo docker rm -f $(sudo docker ps -aq) || true
            sudo docker system prune -af || true

            mkdir -p ~/app
            cd ~/app

            echo "ðŸ“„ Writing nginx.conf"
            cat > nginx.conf << 'EOF'
            server {
              listen 80;

              location / {
                proxy_pass http://mean-frontend:80;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
              }

              location /api/ {
                proxy_pass http://43.205.203.38:8080/api/tutorials;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
              }
            }
            EOF

            echo "ðŸ“„ Writing docker-compose.yml"
            cat > docker-compose.yml << 'EOF'
            services:

              mongodb:
                image: mongo:6
                container_name: mongodb
                restart: always
                networks:
                  - mean-net

              backend:
                image: DOCKER_USER/mean-backend:latest
                container_name: mean-backend
                restart: always
                environment:
                  - MONGO_URI=mongodb://mongodb:27017/testdb
                depends_on:
                  - mongodb
                networks:
                  - mean-net

              frontend:
                image: DOCKER_USER/mean-frontend:latest
                container_name: mean-frontend
                restart: always
                depends_on:
                  - backend
                networks:
                  - mean-net

              nginx:
                image: nginx:alpine
                container_name: mean-nginx
                restart: always
                ports:
                  - "80:80"
                volumes:
                  - ./nginx.conf:/etc/nginx/conf.d/default.conf
                depends_on:
                  - frontend
                  - backend
                networks:
                  - mean-net

            networks:
              mean-net:
                driver: bridge
            EOF

            echo "ðŸ” Replace Docker username in compose file"
            sed -i 's/DOCKER_USER/${{ secrets.DOCKER_USERNAME }}/g' docker-compose.yml

            echo "â¬‡ï¸ Pull latest images"
            sudo docker compose pull

            echo "ðŸš€ Start all containers"
            sudo docker compose up -d

            echo "âœ… Running containers:"
            sudo docker ps