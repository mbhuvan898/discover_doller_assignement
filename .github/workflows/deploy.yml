name: Deploy MEAN App

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - uses: actions/checkout@v4

      # Docker login
      - name: Login DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Build
      - name: Build backend
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mean-backend:latest ./backend

      - name: Build frontend
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mean-frontend:latest ./frontend

      # Push
      - name: Push backend
        run: docker push ${{ secrets.DOCKER_USERNAME }}/mean-backend:latest

      - name: Push frontend
        run: docker push ${{ secrets.DOCKER_USERNAME }}/mean-frontend:latest

      # Deploy EC2
      - name: Deploy EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ðŸ”¥ Clean old containers"
            sudo docker rm -f $(sudo docker ps -aq) || true
            sudo docker system prune -af || true

            mkdir -p ~/app
            cd ~/app

            echo "ðŸ“„ nginx.conf"
            cat > nginx.conf << 'EOF'
            server {
              listen 80;

              location / {
                proxy_pass http://mean-frontend:80;
              }

              location /api/ {
                proxy_pass http://mean-backend:8080/;
              }
            }
            EOF

            echo "ðŸ“„ docker-compose.yml"
            cat > docker-compose.yml << EOF
            services:

              mongodb:
                image: mongo:6
                container_name: mongodb
                restart: always
                networks:
                  - mean-net

              backend:
                image: ${{ secrets.DOCKER_USERNAME }}/mean-backend:latest
                container_name: mean-backend
                restart: always
                environment:
                  - MONGO_URL=mongodb://mongodb:27017/testdb
                depends_on:
                  - mongodb
                ports:
                  - "8080:8080"
                networks:
                  - mean-net

              frontend:
                image: ${{ secrets.DOCKER_USERNAME }}/mean-frontend:latest
                container_name: mean-frontend
                restart: always
                depends_on:
                  - backend
                networks:
                  - mean-net

              nginx:
                image: nginx:alpine
                container_name: mean-nginx
                restart: always
                ports:
                  - "80:80"
                volumes:
                  - ./nginx.conf:/etc/nginx/conf.d/default.conf
                depends_on:
                  - frontend
                  - backend
                networks:
                  - mean-net

            networks:
              mean-net:
                driver: bridge
            EOF

            echo "â¬‡ï¸ Pull images"
            sudo docker compose pull

            echo "ðŸš€ Start"
            sudo docker compose up -d

            echo "âœ… Containers"
            sudo docker ps