name: Deploy MEAN App

on:
push:
branches: [ main ]

jobs:

build-and-deploy:
runs-on: ubuntu-latest

```
steps:
  # 1ï¸âƒ£ Checkout
  - name: Checkout
    uses: actions/checkout@v4

  # 2ï¸âƒ£ Docker login
  - name: Login DockerHub
    uses: docker/login-action@v3
    with:
      username: ${{ secrets.DOCKER_USERNAME }}
      password: ${{ secrets.DOCKER_TOKEN }}

  # 3ï¸âƒ£ Build images
  - name: Build backend
    run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mean-backend ./backend

  - name: Build frontend
    run: docker build -t ${{ secrets.DOCKER_USERNAME }}/mean-frontend ./frontend

  # 4ï¸âƒ£ Push images
  - name: Push backend
    run: docker push ${{ secrets.DOCKER_USERNAME }}/mean-backend

  - name: Push frontend
    run: docker push ${{ secrets.DOCKER_USERNAME }}/mean-frontend

  # 5ï¸âƒ£ Deploy EC2
  - name: Deploy EC2
    uses: appleboy/ssh-action@v1.0.3
    with:
      host: ${{ secrets.EC2_HOST }}
      username: ubuntu
      key: ${{ secrets.EC2_SSH_KEY }}

      script: |
        echo "ðŸ”¥ Clean old"
        sudo docker rm -f $(sudo docker ps -aq) || true
        sudo docker system prune -af || true

        mkdir -p ~/app
        cd ~/app

        echo "ðŸ“„ nginx config"
        cat > nginx.conf << 'EOF'
        server {
          listen 80;

          location / {
            proxy_pass http://mean-frontend;
          }

          location /api/ {
            proxy_pass http://mean-backend:8080/;
          }
        }
        EOF

        echo "ðŸ“„ docker compose"
        cat > docker-compose.yml << 'EOF'
        services:

          mongodb:
            image: mongo:6
            container_name: mongodb
            restart: always
            networks:
              - mean-net

          backend:
            image: ${{ secrets.DOCKER_USERNAME }}/mean-backend:latest
            container_name: mean-backend
            restart: always
            depends_on:
              - mongodb
            networks:
              - mean-net

          frontend:
            image: ${{ secrets.DOCKER_USERNAME }}/mean-frontend:latest
            container_name: mean-frontend
            restart: always
            depends_on:
              - backend
            networks:
              - mean-net

          nginx:
            image: nginx:alpine
            container_name: mean-nginx
            ports:
              - "80:80"
            volumes:
              - ./nginx.conf:/etc/nginx/conf.d/default.conf
            depends_on:
              - frontend
              - backend
            networks:
              - mean-net

        networks:
          mean-net:
            driver: bridge
        EOF

        echo "â¬‡ï¸ Pull images"
        sudo docker compose pull

        echo "ðŸš€ Deploy"
        sudo docker compose up -d
```
